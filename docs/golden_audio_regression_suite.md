# Golden Audio Regression Suite

## Purpose
The golden audio regression suite is the safety net that protects DiaRemot's speech pipeline from silent accuracy regressions. It captures a curated, versioned corpus of reference audio clips together with the expected transcription, segmentation, diarization, affect, and analytics outputs generated by the production configuration of `AudioAnalysisPipelineV2`. By replaying these clips after every significant change, we can detect:

- Drift in automatic speech recognition (ASR) quality (e.g., word error rate, punctuation differences)
- Diarization mistakes such as speaker swaps, missed speech, or excessive segmentation
- Regressions in paralinguistic metrics (prosody, pause analysis, vocal quality)
- Changes in downstream analytics such as intent and emotion labeling

Because DiaRemot integrates multiple ONNX and PyTorch components, the suite ensures we are alerted when upgrading models, refactoring stages, or tuning orchestrator parameters alters observable behavior.

## Composition of the Golden Set

1. **Audio coverage**
   - Include conversational, monologue, and noisy room recordings.
   - Preserve edge cases like overlapping speech, short utterances, and long pauses.
   - Store 16 kHz mono WAV files under `tests/data/golden_audio/` (or an equivalent path tracked in Git LFS).
2. **Reference manifests**
   - For each audio file, maintain a manifest JSON (or CSV) with:
     - Expected transcript text and timestamped segments.
     - Speaker labels for diarization checkpoints.
     - Intent/emotion probabilities or top labels.
     - Paralinguistic metrics with tolerances (min/max or percentage error bounds).
   - Manifests should be versioned alongside the audio and reviewed like code.
3. **Hash locking**
   - Record SHA256 hashes of the audio assets so that accidental edits are detected during CI runs.

## Execution Flow

1. **Pipeline invocation**
   - Use `python -m diaremot.pipeline.audio_pipeline_core run --config golden_regression.yml` (a thin wrapper over `run_pipeline`) to process each clip with the same configuration used in production, forcing CPU execution.
2. **Metric computation**
   - ASR: Compute word error rate and character error rate against the manifest transcript.
   - Diarization: Compare RTTM files using diarization error rate (DER) and speaker confusion counts.
   - Paralinguistics: Validate each metric within the allowed tolerance band defined in the manifest.
   - Intent/emotion: Compare class probabilities with cosine similarity or enforce top-1 label stability.
3. **Reporting**
   - Emit a Markdown or HTML summary showing pass/fail per clip and per metric.
   - Persist detailed diffs (e.g., transcript alignment) under `artifacts/golden_audio/<timestamp>/` for debugging.

## Integration Into Continuous Delivery

- **Pre-merge CI**: Add a GitHub Actions job that runs `pytest tests/golden_audio` (or an equivalent script) on pull requests touching `src/diaremot/pipeline` or model assets.
- **Nightly canary**: Schedule a nightly pipeline run that revalidates against the golden set using the latest models downloaded into `DIAREMOT_MODEL_DIR`.
- **Baseline refresh**: When intentionally changing model behavior, run the suite locally, capture the new outputs, and update the manifests in a dedicated PR that documents the rationale for the baseline shift.

## Benefits

- Provides deterministic guardrails for complex multi-stage audio processing.
- Shortens triage time by pointing directly to the stage that regressed.
- Documents expected behavior for new contributors and reviewers.

## Considerations & Best Practices

- Keep the golden set compact (â‰¤10 minutes total audio) to keep CI runtimes reasonable on CPU-only hardware.
- Use lossless audio formats and avoid re-encoding to prevent drift from codec artifacts.
- Track tolerances explicitly so the suite tolerates benign numeric jitter while flagging real regressions.
- Rebuild the baseline immediately after upgrading ONNXRuntime, faster-whisper, or other core dependencies.
- Store the regression harness in `tests/golden_audio/` with pytest fixtures that download or stage assets under `.cache/` to respect the repository's caching policy.

By institutionalizing the golden audio regression suite, DiaRemot gains confidence that architectural refactors and model updates preserve the production-quality speech analytics that downstream teams rely on.
