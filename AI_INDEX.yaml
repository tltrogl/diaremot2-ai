meta:
  generated: '2025-10-05T00:00:00Z'
  purpose: Authoritative pipeline mapping - stages, models, schema
  verified_against:
    - src/diaremot/pipeline/stages/__init__.py
    - src/diaremot/pipeline/orchestrator.py
    - src/diaremot/pipeline/outputs.py
    - src/diaremot/cli.py

project:
  name: DiaRemot
  description: CPU-only speech intelligence pipeline - diarization + transcription + affect + paralinguistics
  
pipeline_stages:
  count: 11
  source: src/diaremot/pipeline/stages/__init__.py::PIPELINE_STAGES
  stages:
    - name: dependency_check
      order: 1
      module: stages/dependency_check.py
      purpose: Validate runtime dependencies
      
    - name: preprocess
      order: 2
      module: stages/preprocess.py
      purpose: Audio normalization, denoising, auto-chunking
      config:
        target_sr: 16000
        denoise: spectral_sub_soft
        loudness_mode: asr
        auto_chunk_threshold_min: 30.0
        
    - name: background_sed
      order: 3
      module: stages/preprocess.py::run_background_sed
      purpose: Sound event detection (PANNs CNN14)
      runtime: ONNXRuntime (preferred), PyTorch fallback
      enabled_by_default: true
      params:
        frame_s: 1.0
        hop_s: 0.5
        enter_thresh: 0.50
        exit_thresh: 0.35
        min_dur_s: 0.30
        merge_gap_s: 0.20
        label_collapse: AudioSet 527 â†’ ~20 groups
        
    - name: diarize
      order: 4
      module: stages/diarize.py
      purpose: Speaker segmentation (Silero VAD + ECAPA + AHC)
      cli_defaults:
        vad_threshold: 0.30
        vad_min_speech_sec: 0.80
        vad_min_silence_sec: 0.80
        speech_pad_sec: 0.20
        ahc_distance_threshold: 0.12
      orchestrator_overrides:
        vad_threshold: 0.35
        speech_pad_sec: 0.10
        ahc_distance_threshold: 0.15
      note: Orchestrator overrides apply when user doesn't set CLI flags
      
    - name: transcribe
      order: 5
      module: stages/asr.py
      purpose: ASR via faster-whisper (CTranslate2)
      model: tiny.en
      default_compute_type: float32
      params:
        beam_size: 1
        temperature: 0.0
        no_speech_threshold: 0.50
        vad_filter: true
        
    - name: paralinguistics
      order: 6
      module: stages/paralinguistics.py
      purpose: Voice quality + prosody (Praat-Parselmouth)
      required: true
      metrics:
        - wpm
        - pause_count
        - pause_time_s
        - pause_ratio
        - f0_mean_hz
        - f0_std_hz
        - loudness_rms
        - disfluency_count
        - vq_jitter_pct
        - vq_shimmer_db
        - vq_hnr_db
        - vq_cpps_db
        
    - name: affect_and_assemble
      order: 7
      module: stages/affect.py
      purpose: Audio/text affect analysis + segment assembly
      runtime: ONNXRuntime (preferred), HuggingFace fallback
      models:
        - audio_vad: VAD (valence/arousal/dominance)
        - speech_emotion: 8-class SER
        - text_emotion: GoEmotions 28-class
        - intent: BART-MNLI zero-shot
        
    - name: overlap_interruptions
      order: 8
      module: stages/summaries.py::run_overlap
      purpose: Turn-taking analysis
      
    - name: conversation_analysis
      order: 9
      module: stages/summaries.py::run_conversation
      purpose: Flow metrics, dominance
      
    - name: speaker_rollups
      order: 10
      module: stages/summaries.py::run_speaker_rollups
      purpose: Per-speaker summaries
      
    - name: outputs
      order: 11
      module: stages/summaries.py::run_outputs
      purpose: Write CSV, JSON, HTML, PDF

csv_schema:
  source: src/diaremot/pipeline/outputs.py::SEGMENT_COLUMNS
  column_count: 39
  columns:
    - file_id
    - start
    - end
    - speaker_id
    - speaker_name
    - text
    - valence
    - arousal
    - dominance
    - emotion_top
    - emotion_scores_json
    - text_emotions_top5_json
    - text_emotions_full_json
    - intent_top
    - intent_top3_json
    - events_top3_json
    - noise_tag
    - asr_logprob_avg
    - snr_db
    - snr_db_sed
    - wpm
    - duration_s
    - words
    - pause_ratio
    - low_confidence_ser
    - vad_unstable
    - affect_hint
    - pause_count
    - pause_time_s
    - f0_mean_hz
    - f0_std_hz
    - loudness_rms
    - disfluency_count
    - error_flags
    - vq_jitter_pct
    - vq_shimmer_db
    - vq_hnr_db
    - vq_cpps_db
    - voice_quality_hint

models:
  - stage: diarize
    component: vad
    name: Silero VAD
    backends: [onnx, torch, energy-fallback]
    
  - stage: diarize
    component: embeddings
    name: ECAPA-TDNN
    backend: onnx
    
  - stage: transcribe
    name: faster-whisper-tiny.en
    backend: ctranslate2
    default_compute_type: float32
    
  - stage: affect
    component: vad_emotion
    name: wav2vec2-large-robust-12-ft-emotion-msp-dim
    backend: transformers
    
  - stage: affect
    component: speech_emotion
    name: wav2vec2-emotion-recognition
    backend: transformers
    
  - stage: affect
    component: text_emotion
    name: roberta-base-go_emotions
    backends: [onnx, transformers]
    
  - stage: affect
    component: intent
    name: bart-large-mnli
    backends: [onnx, transformers]
    
  - stage: background_sed
    name: PANNs CNN14
    backends: [onnx, pytorch]
    
  - stage: paralinguistics
    name: Praat-Parselmouth
    backend: native

cli_reference:
  main_entry: python -m diaremot.cli run
  default_compute_type: float32
  key_flags:
    - "--input / -i: audio file"
    - "--outdir / -o: output directory"
    - "--asr-compute-type: float32|int8|int8_float16"
    - "--vad-threshold: override orchestrator default (0.35)"
    - "--ahc-distance-threshold: override orchestrator default (0.15)"
    - "--disable-sed: skip sound events"
    - "--disable-affect: skip emotion/intent"
    - "--profile: default|fast|accurate|offline|path"

outputs:
  - diarized_transcript_with_emotion.csv
  - segments.jsonl
  - speakers_summary.csv
  - summary.html
  - summary.pdf
  - speaker_registry.json
  - events_timeline.csv
  - events.jsonl
  - timeline.csv
  - qc_report.json

critical_notes:
  - Pipeline has exactly 11 stages (no auto_tune stage exists)
  - Orchestrator applies VAD tuning inline in __init__, not as separate stage
  - Main CLI defaults to compute_type=float32 (not int8)
  - Orchestrator overrides some diarization params for better performance
  - Schema is 39 columns - do not modify without migration
  - Paralinguistics stage is required and cannot be skipped
  - SED enabled by default
